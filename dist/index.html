<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>js13kgames 2017</title><style type="text/css">body {
  background-color: white;
  color: black;
  overflow: hidden;
}

body.flash {
  background-color: red;
  color: yellow;
}
</style></head><body><div class="score"><p>Score:<span id="elapsed"></span></p></div><script type="text/javascript">!function(){"use strict";class t{static create(e){const n=t.createCanvas(e);window.document.body.appendChild(n);const s=t.createContainer(),i=t.createLevel(),r=t.createAngleInput();return s.appendChild(i),s.appendChild(r),window.document.body.appendChild(s),n}static createAngleInput(){const t=window.document.createElement("label"),e=window.document.createTextNode("Angle in degree"),n=window.document.createElement("input");return n.setAttribute("id","angle"),n.setAttribute("min","1"),n.setAttribute("type","number"),n.setAttribute("value","5"),t.appendChild(e),t.appendChild(n),t}static createCanvas(e){const n=window.document.createElement("canvas");return n.setAttribute("id",e),n.setAttribute("height",`${t.HEIGHT}px`),n.setAttribute("width",`${t.WIDTH}px`),n}static createContainer(){return window.document.createElement("div")}static createLevel(){const t=window.document.createElement("label"),e=window.document.createTextNode("Level"),n=window.document.createElement("input");return n.setAttribute("id","level"),n.setAttribute("min","1"),n.setAttribute("type","number"),n.setAttribute("value","5"),t.appendChild(e),t.appendChild(n),t}static get GATESIZE(){return.15}static get HEIGHT(){return Math.min(window.innerHeight,window.innerWidth)}static get USERSIZE(){return t.WALLDISTANCE/3}static get USERROTATION(){const t=window.document.getElementById("angle"),n=parseInt(t.value,10);return e.mapDegreeToRadians(n)}static get USERVELOCITY(){return 3}static get WALLDISTANCE(){return.06*(t.HEIGHT+t.WIDTH)/2}static get WIDTH(){return Math.min(window.innerHeight,window.innerWidth)}static updateTimer(t){window.document.getElementById("elapsed").innerText=t}render(e,n){this.context.clearRect(0,0,t.WIDTH,t.HEIGHT),n.forEach(t=>{this.renderWall(t)}),this.renderHero(e)}renderHero(e){const n=.9*(2*Math.PI),s=t.USERSIZE,i=this.context,r=e.x,a=e.y;i.fillStyle="black",i.beginPath(),i.arc(r,a,s,0,n),i.fill()}renderWall(e){const n=t.WIDTH/2,s=t.HEIGHT/2,i=this.context,r=e.endGate,a=e.radius,o=e.startGate;i.beginPath(),i.arc(n,s,a,r,o),i.stroke()}constructor(e){this.element=t.create(e),this.context=this.element.getContext("2d")}}class e{static coordinationSystemToCenter(e,n){return{x:e-t.WIDTH/2,y:n-t.HEIGHT/2}}static coordinationSystemToVertex(e,n){return{p:e+t.WIDTH/2,q:n+t.HEIGHT/2}}static euclideanDistance(t,e){return Math.sqrt(t*t+e*e)}static mapCartesianToPolar(t){const e=t.x,n=t.y;return{r:Math.sqrt(Math.pow(e,2)+Math.pow(n,2)),phi:Math.atan2(n,e)}}static mapDegreeToRadians(t){return t*Math.PI/180}static mapPolarToCartesian(t){const e=t.phi,n=t.r;return{x:n*Math.cos(e),y:n*Math.sin(e)}}static mapRadiansToDegree(t){return 180*t/Math.PI}static normaliseAngle(t){const e=2*Math.PI;return t<0?(t+e)%e:t%e}}class n{static registerStore(t){const e={angle:0,name:"Jane Doe",radius:0,timeElapsed:(new Date).toISOString()};return t.register("user",e),t}get store(){return this.globalStore.get("user")}set store(t){this.globalStore.dispatch(t)}get x(){const t=this.store.angle,n={r:this.store.radius,phi:t},s=e.mapPolarToCartesian(n);return e.coordinationSystemToVertex(s.x,s.y).p}get y(){const t=this.store.angle,n={r:this.store.radius,phi:t},s=e.mapPolarToCartesian(n);return e.coordinationSystemToVertex(s.x,s.y).q}moveDown(){const e={key:"user",payload:{radius:this.store.radius-t.USERVELOCITY},type:"UserMoveDown"};this.store=e}moveLeft(){const e={key:"user",payload:{angle:this.store.angle-t.USERROTATION},type:"UserMoveLeft"};this.store=e}moveRight(){const e={key:"user",payload:{angle:this.store.angle+t.USERROTATION},type:"UserMoveRight"};this.store=e}moveUp(){const e={key:"user",payload:{radius:this.store.radius+t.USERVELOCITY},type:"UserMoveUp"};this.store=e}constructor(t){const e=n.registerStore(t);this.globalStore=e}}class s{dispatch(t){const e=t.payload,n=t.type;this.update(t),n in this.actions&&this.actions[n].forEach(t=>{t(e)})}get(t){return this.store[t]}register(t,e){this.store[t]=e}subscribe(t,e){t in this.actions?this.actions[t].push(e):this.actions[t]=[e]}update(t){const e=t.key,n=t.payload,s=this.store[e];this.store[e]=Object.assign(s,n)}constructor(){this.actions={},this.store={}}}class i{handleTouchMove(t){if(!this.xDown||!this.yDown)return;const e=this.handlers,n=t.touches[0].clientX,s=t.touches[0].clientY;this.xDiff=this.xDown-n,this.yDiff=this.yDown-s,Math.abs(this.xDiff)>Math.abs(this.yDiff)?this.xDiff>0?e.onLeft():e.onRight():this.yDiff>0?e.onUp():e.onDown(),this.xDown=null,this.yDown=null}onTouchMove(t){this.handleTouchMove(t)}onTouchStart(t){this.xDown=t.touches[0].clientX,this.yDown=t.touches[0].clientY}run(){const t=this,e=t.onTouchMove;this.element.addEventListener("touchmove",e.bind(t),!1)}constructor(t,e){this.xDown=null,this.yDown=null,this.element=t,this.element.addEventListener("touchstart",this.onTouchStart.bind(this),!1);const n=e.onDown,s=e.onLeft,i=e.onRight,r=e.onUp;this.handlers={onDown:n,onLeft:s,onRight:i,onUp:r}}}class r{static randomiseGate(){const n=2*Math.PI,s=0+Math.random()*n;return{end:e.normaliseAngle(s+t.GATESIZE*n),start:s}}constructor(t){const e=r.randomiseGate(),n=e.end,s=e.start;this.radius=t,this.startGate=s,this.endGate=n}}window.requestAnimationFrame=window.requestAnimationFrame||(()=>null);class a{static get KEYMAP(){return{LEFT:37,UP:38,RIGHT:39,DOWN:40}}static notifyUser(){const t=(new Date).toISOString();console.log("Hit wall",t),window.document.body.classList.add("flash"),setTimeout(()=>{window.document.body.classList.remove("flash")},500)}static compareAngle(n,s){const i=e.mapCartesianToPolar(e.coordinationSystemToCenter(n.x,n.y)),r=i.r+t.USERSIZE,a=t.WALLDISTANCE;return s.filter(t=>!(r-t.radius>a)&&!(t.radius-r>a)).map(t=>{const n=e.normaliseAngle(t.startGate),s=e.normaliseAngle(t.endGate),r=e.normaliseAngle(2*Math.PI-i.phi);return!(n<r&&s>r)}).reduce((t,e)=>t||e)}static compareRadii(n,s){const i=e.mapCartesianToPolar(e.coordinationSystemToCenter(n.x,n.y)),r=i.r+t.USERSIZE,a=t.WALLDISTANCE;return s.map(t=>t.radius).filter(t=>!(r-t>a)&&!(t-r>a)).map(e=>!(i.r-t.USERSIZE>e)&&!(i.r+t.USERSIZE<e)).reduce((t,e)=>t||e)}static detectCollision(t,e){const n=a.compareAngle(t,e),s=a.compareRadii(t,e);return n&&s}addWall(t){this.walls.push(t)}draw(){const t=this.hero,e=this.walls;a.detectCollision(t,e)&&a.notifyUser(),this.world.render(t,e)}init(){const e=this,n=this.update;[1,2,3,4,5,6].forEach(e=>{const n=new r(e*t.WALLDISTANCE);this.addWall(n)}),this.registerArrowKeyHandlers(),this.registerSwipeHandlers(),window.requestAnimationFrame(n.bind(e))}onKeyDown(t){const e=this.hero,n=t.keyCode,s=a.KEYMAP,i=this,r=this.update;switch(n){case s.LEFT:e.moveLeft(),t.preventDefault();break;case s.UP:e.moveUp(),t.preventDefault();break;case s.RIGHT:e.moveRight(),t.preventDefault();break;case s.DOWN:e.moveDown(),t.preventDefault();break;default:console.log("Received keyCode",t.keyCode)}window.requestAnimationFrame(r.bind(i))}registerArrowKeyHandlers(){const t=this,e=this.onKeyDown;window.document.body.addEventListener("keydown",e.bind(t),!1)}registerSwipeHandlers(){const t=this.hero,e=this,n=this.update,s={onDown:()=>{t.moveDown(),window.requestAnimationFrame(n.bind(e))},onLeft:()=>{t.moveLeft(),window.requestAnimationFrame(n.bind(e))},onRight:()=>{t.moveRight(),window.requestAnimationFrame(n.bind(e))},onUp:()=>{t.moveUp(),window.requestAnimationFrame(n.bind(e))}};new i(this.world.element,s).run()}update(t){const e=t-this.lastUpdateTimestamp,n=e<0,s=this,i=this.update;(e>60||n)&&(this.draw(),this.updateTimer(),window.requestAnimationFrame(i.bind(s)),this.lastUpdateTimestamp=t)}updateTimer(){const e=this.startTime,n=new Date,s=Math.round((n-e)/1e3);t.updateTimer(s)}constructor(e){const i=new s;this.hero=new n(i),this.world=new t(e),this.startTime=new Date,this.lastUpdateTimestamp=Number(new Date),this.state={user:{angle:0,name:"Jane Doe",radius:0,timeElapsed:(new Date).toISOString()},walls:[{gate:{start:0,end:1},radius:0}],world:{height:t.HEIGHT,width:t.WIDTH}},this.walls=[]}}new a("game").init()}();
</script></body></html>