<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>js13kgames 2017</title><style type="text/css">body {
  background-color: white;
  color: black;
}

body.flash {
  background-color: red;
  color: yellow;
}
</style></head><body><h1>js13kgames 2017</h1><div id="elapsed"></div><script type="text/javascript">!function(){"use strict";class t{static create(e){const s=document.createElement("canvas");return s.setAttribute("id",e),s.setAttribute("height",`${t.HEIGHT}px`),s.setAttribute("width",`${t.WIDTH}px`),window.document.body.appendChild(s),s}static get GATESIZE(){return.15}static get HEIGHT(){return Math.min(window.innerHeight,window.innerWidth)}static get USERSIZE(){return t.WALLDISTANCE/3}static get USERROTATION(){return e.mapDegreeToRadians(5)}static get USERVELOCITY(){return 3}static get WALLDISTANCE(){return.06*(t.HEIGHT+t.WIDTH)/2}static get WIDTH(){return Math.min(window.innerHeight,window.innerWidth)}static updateTimer(t){window.document.getElementById("elapsed").innerText=t}render(e,s){this.context.clearRect(0,0,t.WIDTH,t.HEIGHT),s.forEach(t=>{this.renderWall(t)}),this.renderHero(e)}renderHero(e){const s=.9*(2*Math.PI),n=t.USERSIZE,i=this.context,{x:o,y:r}=e;i.fillStyle="black",i.beginPath(),i.arc(o,r,n,0,s),i.fill()}renderWall(e){const s=t.WIDTH/2,n=t.HEIGHT/2,i=this.context,{endGate:o,radius:r,startGate:a}=e;i.beginPath(),i.arc(s,n,r,o,a),i.stroke()}constructor(e){this.element=t.create(e),this.context=this.element.getContext("2d")}}class e{static coordinationSystemToCenter(e,s){return{x:e-t.WIDTH/2,y:s-t.HEIGHT/2}}static coordinationSystemToVertex(e,s){return{p:e+t.WIDTH/2,q:s+t.HEIGHT/2}}static euclideanDistance(t,e){return Math.sqrt(t*t+e*e)}static mapCartesianToPolar(t){const{x:e,y:s}=t;return{r:Math.sqrt(Math.pow(e,2)+Math.pow(s,2)),phi:Math.atan2(s,e)}}static mapDegreeToRadians(t){return t*Math.PI/180}static mapPolarToCartesian(t){const{r:e,phi:s}=t;return{x:e*Math.cos(s),y:e*Math.sin(s)}}static mapRadiansToDegree(t){return 180*t/Math.PI}static normaliseAngle(t){const e=2*Math.PI;return t<0?(t+e)%e:t%e}}class s{static registerStore(t){const e={angle:0,name:"Jane Doe",radius:0,timeElapsed:(new Date).toISOString()};return t.register("user",e),t}get store(){return this.globalStore.get("user")}set store(t){this.globalStore.dispatch(t)}get x(){const{angle:t,radius:s}=this.store,n={r:s,phi:t},i=e.mapPolarToCartesian(n);return e.coordinationSystemToVertex(i.x,i.y).p}get y(){const{angle:t,radius:s}=this.store,n={r:s,phi:t},i=e.mapPolarToCartesian(n);return e.coordinationSystemToVertex(i.x,i.y).q}moveDown(){const{radius:e}=this.store,s={key:"user",payload:{radius:e-t.USERVELOCITY},type:"UserMoveDown"};this.store=s}moveLeft(){const{angle:e}=this.store,s={key:"user",payload:{angle:e-t.USERROTATION},type:"UserMoveLeft"};this.store=s}moveRight(){const{angle:e}=this.store,s={key:"user",payload:{angle:e+t.USERROTATION},type:"UserMoveRight"};this.store=s}moveUp(){const{radius:e}=this.store,s={key:"user",payload:{radius:e+t.USERVELOCITY},type:"UserMoveUp"};this.store=s}constructor(t){const e=s.registerStore(t);this.globalStore=e}}class n{dispatch(t){const{payload:e,type:s}=t;this.update(t),s in this.actions&&this.actions[s].forEach(t=>{t(e)})}get(t){return this.store[t]}register(t,e){this.store[t]=e}subscribe(t,e){t in this.actions?this.actions[t].push(e):this.actions[t]=[e]}update(t){const{key:e,payload:s}=t,n=this.store[e];this.store[e]=Object.assign(n,s)}constructor(){this.actions={},this.store={}}}class i{handleTouchMove(t){if(!this.xDown||!this.yDown)return;const e=this.handlers,s=t.touches[0].clientX,n=t.touches[0].clientY;this.xDiff=this.xDown-s,this.yDiff=this.yDown-n,Math.abs(this.xDiff)>Math.abs(this.yDiff)?this.xDiff>0?e.onLeft():e.onRight():this.yDiff>0?e.onUp():e.onDown(),this.xDown=null,this.yDown=null}onTouchMove(t){this.handleTouchMove(t)}onTouchStart(t){this.xDown=t.touches[0].clientX,this.yDown=t.touches[0].clientY}run(){const t=this,e=t.onTouchMove;this.element.addEventListener("touchmove",e.bind(t),!1)}constructor(t,e){this.xDown=null,this.yDown=null,this.element=t,this.element.addEventListener("touchstart",this.onTouchStart.bind(this),!1);const{onDown:s,onLeft:n,onRight:i,onUp:o}=e;this.handlers={onDown:s,onLeft:n,onRight:i,onUp:o}}}class o{static randomiseGate(){const s=2*Math.PI,n=0+Math.random()*s;return{end:e.normaliseAngle(n+t.GATESIZE*s),start:n}}constructor(t){const{start:e,end:s}=o.randomiseGate();this.radius=t,this.startGate=e,this.endGate=s}}class r{static get KEYMAP(){return{LEFT:37,UP:38,RIGHT:39,DOWN:40}}static notifyUser(){const t=(new Date).toISOString();console.log("Hit wall",t),window.document.body.classList.add("flash"),setTimeout(()=>{window.document.body.classList.remove("flash")},500)}static compareAngle(s,n){const i=e.mapCartesianToPolar(e.coordinationSystemToCenter(s.x,s.y)),o=i.r+t.USERSIZE,r=t.WALLDISTANCE;return n.filter(t=>!(o-t.radius>r)&&!(t.radius-o>r)).map(t=>{const s=e.normaliseAngle(t.startGate),n=e.normaliseAngle(t.endGate),o=e.normaliseAngle(2*Math.PI-i.phi);return!(s<o&&n>o)}).reduce((t,e)=>t||e)}static compareRadii(s,n){const i=e.mapCartesianToPolar(e.coordinationSystemToCenter(s.x,s.y)),o=i.r+t.USERSIZE,r=t.WALLDISTANCE;return n.map(t=>t.radius).filter(t=>!(o-t>r)&&!(t-o>r)).map(e=>!(i.r-t.USERSIZE>e)&&!(i.r+t.USERSIZE<e)).reduce((t,e)=>t||e)}static detectCollision(t,e){const s=r.compareAngle(t,e),n=r.compareRadii(t,e);return s&&n}addWall(t){this.walls.push(t)}draw(){const t=this.hero,e=this.walls;r.detectCollision(t,e)&&r.notifyUser(),this.world.render(t,e)}init(){const e=this,s=this.update;[1,2,3,4,5,6].forEach(e=>{const s=new o(e*t.WALLDISTANCE);this.addWall(s)}),this.registerArrowKeyHandlers(),this.registerSwipeHandlers(),window.requestAnimationFrame(s.bind(e))}onKeyDown(t){const e=this.hero,s=t.keyCode,n=r.KEYMAP,i=this,o=this.update;switch(s){case n.LEFT:e.moveLeft(),t.preventDefault();break;case n.UP:e.moveUp(),t.preventDefault();break;case n.RIGHT:e.moveRight(),t.preventDefault();break;case n.DOWN:e.moveDown(),t.preventDefault();break;default:console.log("Received keyCode",t.keyCode)}window.requestAnimationFrame(o.bind(i))}registerArrowKeyHandlers(){const t=this,e=this.onKeyDown;window.document.body.addEventListener("keydown",e.bind(t),!1)}registerSwipeHandlers(){const t=this.hero,e=this,s=this.update,n={onDown:()=>{t.moveDown(),window.requestAnimationFrame(s.bind(e))},onLeft:()=>{t.moveLeft(),window.requestAnimationFrame(s.bind(e))},onRight:()=>{t.moveRight(),window.requestAnimationFrame(s.bind(e))},onUp:()=>{t.moveUp(),window.requestAnimationFrame(s.bind(e))}};new i(this.world.element,n).run()}update(t){const e=t-this.lastUpdateTimestamp,s=e<0,n=this,i=this.update;(e>60||s)&&(this.draw(),this.updateTimer(),window.requestAnimationFrame(i.bind(n)),this.lastUpdateTimestamp=t)}updateTimer(){const e=this.startTime,s=new Date,n=Math.round((s-e)/1e3);t.updateTimer(n)}constructor(e){const i=new n;this.hero=new s(i),this.world=new t(e),this.startTime=new Date,this.lastUpdateTimestamp=Number(new Date),this.state={user:{angle:0,name:"Jane Doe",radius:0,timeElapsed:(new Date).toISOString()},walls:[{gate:{start:0,end:1},radius:0}],world:{height:t.HEIGHT,width:t.WIDTH}},this.walls=[]}}new r("game").init()}();
</script></body></html>